# ä»»åŠ¡å®ŒæˆæŠ¥å‘Š

## 1. ä»»åŠ¡æ¦‚è¿° (Task Overview)

*   **ä»»åŠ¡ID/åç§°**: è‡ªå®šä¹‰APIåœ°å€å’ŒKeyçš„TabåŠŸèƒ½å¼€å‘
*   **æ¥æº**: å“åº”ç”¨æˆ·å…³äº"AIè®¾ç½®ä¸­å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰apiåœ°å€å’Œkeyçš„tab"çš„éœ€æ±‚
*   **è§„åˆ’è“å›¾ (Plan Blueprint)**: N/A
*   **å®Œæˆæ—¶é—´**: 2025-01-25 15:00:00
*   **Git Commit Hash**: cb8b06802379a475dec15ee25e7e73bf6d4fa40d

## 2. æ ¸å¿ƒå®ç° (Core Implementation)

### a. æ–¹æ³•è®º/è®¾è®¡æ€è·¯
é‡‡ç”¨äº†åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œåœ¨ç°æœ‰çš„AIè®¾ç½®ç»„ä»¶åŸºç¡€ä¸Šæ‰©å±•è‡ªå®šä¹‰APIåŠŸèƒ½ã€‚ä¸»è¦åŒ…æ‹¬ï¼š
1. **UIå±‚æ‰©å±•**: åœ¨AIè®¾ç½®ç»„ä»¶ä¸­æ·»åŠ æ–°çš„"è‡ªå®šä¹‰API"æ ‡ç­¾é¡µï¼ŒåŒ…å«APIåç§°ã€åŸºç¡€URLã€APIå¯†é’¥ã€æä¾›å•†ç±»å‹ç­‰é…ç½®é¡¹
2. **é€‚é…å™¨å±‚æ‰©å±•**: åˆ›å»ºCustomAPIAdapterç±»ï¼Œæ”¯æŒOpenAIå…¼å®¹çš„APIæ ¼å¼ï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£
3. **æ¡†æ¶å±‚é›†æˆ**: åœ¨LLMæ¡†æ¶ä¸­é›†æˆè‡ªå®šä¹‰APIé€‚é…å™¨ï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢
4. **é…ç½®ç®¡ç†**: æ‰©å±•é…ç½®ç³»ç»Ÿï¼Œæ”¯æŒè‡ªå®šä¹‰APIé…ç½®çš„ä¿å­˜å’ŒåŠ è½½

### b. ä¸»è¦å˜æ›´æ–‡ä»¶ (Key Changed Files)
*   `MODIFIED`: `src/ui/components/settings/ai_settings_widget.py` - æ·»åŠ è‡ªå®šä¹‰APIæ ‡ç­¾é¡µå’Œæµ‹è¯•åŠŸèƒ½
*   `MODIFIED`: `src/llm/model_adapters.py` - æ–°å¢CustomAPIAdapteré€‚é…å™¨ç±»
*   `MODIFIED`: `src/ui/model_factory_tab.py` - é›†æˆè‡ªå®šä¹‰APIåˆ°AIåŠ©æ‰‹ç•Œé¢
*   `MODIFIED`: `src/ui/settings_tab.py` - æ›´æ–°AIé…ç½®åŒæ­¥é€»è¾‘

### c. å…³é”®ä»£ç ç‰‡æ®µ (Optional but Recommended)

**è‡ªå®šä¹‰APIé€‚é…å™¨æ ¸å¿ƒå®ç°**
```python
class CustomAPIAdapter(LLMAdapter):
    """è‡ªå®šä¹‰APIé€‚é…å™¨ - æ”¯æŒOpenAIå…¼å®¹çš„API"""
    
    def __init__(self, api_key: str, model: str = 'custom-model', base_url: str = None, 
                 provider_type: str = "OpenAIå…¼å®¹", temperature: float = 0.7, 
                 max_tokens: int = 1000):
        super().__init__(model)
        self.api_key = api_key
        self.model = model
        self.base_url = base_url
        self.provider_type = provider_type
        self.temperature = temperature
        self.max_tokens = max_tokens
        
        # æ£€æŸ¥åŸºæœ¬é…ç½®
        if not api_key or not base_url:
            self.available = False
            print("è­¦å‘Š: è‡ªå®šä¹‰APIéœ€è¦æä¾›api_keyå’Œbase_url")
        else:
            self.available = True
    
    def generate_response(self, prompt: str, context: Optional[Dict] = None) -> str:
        """ç”Ÿæˆå“åº”"""
        if not self.available:
            return "è‡ªå®šä¹‰APIä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®"
        
        try:
            self.request_count += 1
            
            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }
            
            # æ„å»ºæ¶ˆæ¯
            messages = []
            
            # æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            system_message = self._get_system_prompt()
            if system_message:
                messages.append({"role": "system", "content": system_message})
            
            # æ·»åŠ ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if context:
                context_str = self._format_context(context)
                if context_str:
                    messages.append({"role": "assistant", "content": context_str})
            
            # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            messages.append({"role": "user", "content": prompt})
            
            # æ„å»ºè¯·æ±‚æ•°æ®
            data = {
                "model": self.model,
                "messages": messages,
                "temperature": self.temperature,
                "max_tokens": self.max_tokens
            }
            
            # å‘é€è¯·æ±‚
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=headers,
                json=data,
                timeout=60
            )
            
            if response.status_code == 200:
                result = response.json()
                content = result['choices'][0]['message']['content']
                
                # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                if 'usage' in result:
                    self.total_tokens += result['usage'].get('total_tokens', 0)
                
                return content
            else:
                error_msg = f"APIè°ƒç”¨å¤±è´¥: HTTP {response.status_code}"
                try:
                    error_data = response.json()
                    if 'error' in error_data:
                        error_msg += f" - {error_data['error'].get('message', '')}"
                except:
                    pass
                return f"APIè°ƒç”¨å¤±è´¥: {error_msg}"
                
        except requests.exceptions.Timeout:
            return "APIè°ƒç”¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
        except requests.exceptions.ConnectionError:
            return "æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥APIåœ°å€"
        except Exception as e:
            return f"APIè°ƒç”¨å‡ºé”™: {str(e)}"
```

**AIè®¾ç½®ç•Œé¢è‡ªå®šä¹‰APIæ ‡ç­¾é¡µ**
```python
def create_custom_api_tab(self):
    """åˆ›å»ºè‡ªå®šä¹‰APIè®¾ç½®æ ‡ç­¾é¡µ"""
    widget = QWidget()
    layout = QVBoxLayout(widget)
    
    # APIé…ç½®ç»„
    api_group = QGroupBox("è‡ªå®šä¹‰APIé…ç½®")
    api_layout = QFormLayout()
    
    # APIåç§°
    self.custom_api_name = QLineEdit()
    self.custom_api_name.setPlaceholderText("ä¸ºæ‚¨çš„è‡ªå®šä¹‰APIå‘½åï¼Œå¦‚ï¼šClaude APIã€æœ¬åœ°LLMç­‰")
    api_layout.addRow("APIåç§°:", self.custom_api_name)
    
    # APIåŸºç¡€URL
    self.custom_base_url = QLineEdit()
    self.custom_base_url.setPlaceholderText("è¾“å…¥APIåŸºç¡€URLï¼Œå¦‚ï¼šhttps://api.example.com/v1")
    api_layout.addRow("åŸºç¡€URL:", self.custom_base_url)
    
    # APIå¯†é’¥ï¼ˆå¸¦æ˜¾ç¤º/éšè—æŒ‰é’®ï¼‰
    key_layout = QHBoxLayout()
    self.custom_api_key = QLineEdit()
    self.custom_api_key.setEchoMode(QLineEdit.Password)
    self.custom_api_key.setPlaceholderText("è¾“å…¥æ‚¨çš„APIå¯†é’¥")
    key_layout.addWidget(self.custom_api_key)
    
    self.show_custom_key_btn = QPushButton("ğŸ‘")
    self.show_custom_key_btn.setMaximumWidth(30)
    self.show_custom_key_btn.clicked.connect(self.toggle_custom_key_visibility)
    key_layout.addWidget(self.show_custom_key_btn)
    api_layout.addRow("APIå¯†é’¥:", key_layout)
    
    # æä¾›å•†ç±»å‹
    self.custom_provider_type = QComboBox()
    self.custom_provider_type.addItems(["OpenAIå…¼å®¹", "è‡ªå®šä¹‰æ ¼å¼"])
    self.custom_provider_type.setCurrentText("OpenAIå…¼å®¹")
    api_layout.addRow("APIç±»å‹:", self.custom_provider_type)
    
    # è¿æ¥æµ‹è¯•
    test_layout = QHBoxLayout()
    self.custom_test_btn = QPushButton("ğŸ” æµ‹è¯•è¿æ¥")
    self.custom_test_btn.clicked.connect(self.test_custom_connection)
    test_layout.addWidget(self.custom_test_btn)
    
    self.custom_test_progress = QProgressBar()
    self.custom_test_progress.setVisible(False)
    test_layout.addWidget(self.custom_test_progress)
    
    test_layout.addStretch()
    api_layout.addRow("è¿æ¥æµ‹è¯•:", test_layout)
    
    # æµ‹è¯•ç»“æœ
    self.custom_test_result = QLabel("å°šæœªæµ‹è¯•")
    self.custom_test_result.setStyleSheet("color: #6c757d;")
    api_layout.addRow("æµ‹è¯•ç»“æœ:", self.custom_test_result)
    
    api_group.setLayout(api_layout)
    layout.addWidget(api_group)
    
    # æ¨¡å‹é…ç½®ç»„
    model_group = QGroupBox("æ¨¡å‹é…ç½®")
    model_layout = QFormLayout()
    
    # æ¨¡å‹é€‰æ‹©ï¼ˆå¯ç¼–è¾‘ä¸‹æ‹‰æ¡†ï¼‰
    model_select_layout = QHBoxLayout()
    self.custom_model = QComboBox()
    self.custom_model.setEditable(True)  # å…è®¸ç”¨æˆ·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°
    self.custom_model.setPlaceholderText("è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°")
    model_select_layout.addWidget(self.custom_model)
    
    # åˆ·æ–°æ¨¡å‹åˆ—è¡¨æŒ‰é’®
    self.refresh_custom_models_btn = QPushButton("ğŸ”„")
    self.refresh_custom_models_btn.setMaximumWidth(30)
    self.refresh_custom_models_btn.setToolTip("åˆ·æ–°å¯ç”¨æ¨¡å‹åˆ—è¡¨")
    self.refresh_custom_models_btn.clicked.connect(self.refresh_custom_model_list)
    model_select_layout.addWidget(self.refresh_custom_models_btn)
    
    model_layout.addRow("æ¨¡å‹åç§°:", model_select_layout)
    
    # æ·»åŠ æ¨¡å‹è¯´æ˜
    model_info = QLabel("ğŸ’¡ æç¤ºï¼šæµ‹è¯•è¿æ¥æˆåŠŸåå°†è‡ªåŠ¨è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°")
    model_info.setStyleSheet("color: #6c757d; font-size: 12px;")
    model_info.setWordWrap(True)
    model_layout.addRow("", model_info)
    
    # å‚æ•°è®¾ç½®
    self.custom_temperature = QDoubleSpinBox()
    self.custom_temperature.setRange(0.0, 2.0)
    self.custom_temperature.setSingleStep(0.1)
    self.custom_temperature.setValue(0.7)
    model_layout.addRow("æ¸©åº¦ (Temperature):", self.custom_temperature)
    
    self.custom_max_tokens = QSpinBox()
    self.custom_max_tokens.setRange(1, 32768)
    self.custom_max_tokens.setValue(1000)
    model_layout.addRow("æœ€å¤§ä»¤ç‰Œæ•°:", self.custom_max_tokens)
    
    model_group.setLayout(model_layout)
    layout.addWidget(model_group)
    
    return widget
```

## 3. éªŒè¯ä¸æµ‹è¯• (Verification & Testing)

### a. éªŒè¯æ–¹æ³•
1. **ä»£ç è¯­æ³•æ£€æŸ¥**: ä½¿ç”¨Pythonç¼–è¯‘å™¨æ£€æŸ¥æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
2. **æ¨¡å—å¯¼å…¥æµ‹è¯•**: éªŒè¯è‡ªå®šä¹‰APIé€‚é…å™¨èƒ½å¤Ÿæ­£ç¡®å¯¼å…¥å’Œåˆ›å»º
3. **é…ç½®ç»“æ„éªŒè¯**: æ£€æŸ¥AIé…ç½®æ–‡ä»¶ç»“æ„æ˜¯å¦æ­£ç¡®åŒ…å«è‡ªå®šä¹‰APIé…ç½®é¡¹
4. **UIç»„ä»¶æµ‹è¯•**: éªŒè¯AIè®¾ç½®ç•Œé¢èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºè‡ªå®šä¹‰APIæ ‡ç­¾é¡µ
5. **é€‚é…å™¨é›†æˆæµ‹è¯•**: ç¡®è®¤è‡ªå®šä¹‰APIé€‚é…å™¨èƒ½å¤Ÿæ­£ç¡®é›†æˆåˆ°LLMæ¡†æ¶ä¸­

### b. æµ‹è¯•ç»“æœ
1. âœ… **ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡**: æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶å‡æ— è¯­æ³•é”™è¯¯
2. âœ… **æ¨¡å—å¯¼å…¥æˆåŠŸ**: CustomAPIAdapterç±»èƒ½å¤Ÿæ­£ç¡®å¯¼å…¥å’Œå®ä¾‹åŒ–
3. âœ… **é…ç½®ç»“æ„å®Œæ•´**: AIé…ç½®æ–‡ä»¶æ­£ç¡®åŒ…å«custom_apié…ç½®é¡¹
4. âœ… **UIç•Œé¢æ­£å¸¸**: è‡ªå®šä¹‰APIæ ‡ç­¾é¡µèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºå’Œäº¤äº’
5. âœ… **æ¡†æ¶é›†æˆæˆåŠŸ**: è‡ªå®šä¹‰APIé€‚é…å™¨èƒ½å¤Ÿæ­£ç¡®é›†æˆåˆ°LLMæ¡†æ¶ä¸­

## 4. å½±å“ä¸é£é™©è¯„ä¼° (Impact & Risk Assessment)

*   **æ­£é¢å½±å“**: 
    - æˆåŠŸæ‰©å±•äº†AIè®¾ç½®åŠŸèƒ½ï¼Œæ”¯æŒç”¨æˆ·é…ç½®è‡ªå®šä¹‰APIæœåŠ¡
    - å¢å¼ºäº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ï¼Œæ”¯æŒæ›´å¤šLLMæœåŠ¡æä¾›å•†
    - ä¿æŒäº†ä¸ç°æœ‰OpenAIã€DeepSeekã€Ollamaç­‰é€‚é…å™¨çš„å…¼å®¹æ€§
    - æä¾›äº†å®Œæ•´çš„æµ‹è¯•å’ŒéªŒè¯åŠŸèƒ½ï¼Œç¡®ä¿APIé…ç½®çš„æ­£ç¡®æ€§

*   **æ½œåœ¨é£é™©/åç»­å·¥ä½œ**: 
    - è‡ªå®šä¹‰APIçš„å…¼å®¹æ€§ä¾èµ–äºæœåŠ¡æä¾›å•†æ˜¯å¦éµå¾ªOpenAI APIæ ¼å¼
    - éœ€è¦ç”¨æˆ·æ­£ç¡®é…ç½®APIåœ°å€å’Œå¯†é’¥ï¼Œé”™è¯¯é…ç½®å¯èƒ½å¯¼è‡´åŠŸèƒ½ä¸å¯ç”¨
    - å»ºè®®åç»­æ·»åŠ æ›´å¤šçš„APIæ ¼å¼æ”¯æŒï¼Œå¦‚Claude APIã€æœ¬åœ°éƒ¨ç½²çš„æ¨¡å‹ç­‰
    - å¯ä»¥è€ƒè™‘æ·»åŠ APIä½¿ç”¨ç»Ÿè®¡å’Œæˆæœ¬ç›‘æ§åŠŸèƒ½

## 5. è‡ªæˆ‘è¯„ä¼°ä¸å­¦ä¹  (Self-Assessment & Learning)

*   **é‡åˆ°çš„æŒ‘æˆ˜**: 
    - éœ€è¦è®¾è®¡é€šç”¨çš„APIé€‚é…å™¨æ¥å£ï¼Œæ—¢è¦æ”¯æŒOpenAIå…¼å®¹æ ¼å¼ï¼Œåˆè¦è€ƒè™‘æœªæ¥æ‰©å±•
    - åœ¨UIè®¾è®¡ä¸­éœ€è¦å¹³è¡¡åŠŸèƒ½å®Œæ•´æ€§å’Œç”¨æˆ·ä½“éªŒï¼Œç¡®ä¿ç•Œé¢ç®€æ´æ˜“ç”¨
    - é…ç½®ç®¡ç†éœ€è¦è€ƒè™‘å‘åå…¼å®¹æ€§ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½

*   **å­¦åˆ°çš„æ•™è®­**: 
    - åœ¨è®¾è®¡é€‚é…å™¨æ¨¡å¼æ—¶ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘æ¥å£çš„ç»Ÿä¸€æ€§å’Œæ‰©å±•æ€§
    - UIç»„ä»¶çš„è®¾è®¡åº”è¯¥éµå¾ªä¸€è‡´æ€§åŸåˆ™ï¼Œä¿æŒä¸ç°æœ‰ç»„ä»¶çš„é£æ ¼ç»Ÿä¸€
    - é…ç½®ç®¡ç†åº”è¯¥é‡‡ç”¨æ¸è¿›å¼æ‰©å±•çš„æ–¹å¼ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§
    - æµ‹è¯•åŠŸèƒ½å¯¹äºç”¨æˆ·é…ç½®éªŒè¯éå¸¸é‡è¦ï¼Œèƒ½å¤Ÿå¤§å¤§å‡å°‘ä½¿ç”¨é”™è¯¯

## 6. åŠŸèƒ½ç‰¹æ€§æ€»ç»“

### æ–°å¢åŠŸèƒ½ç‰¹æ€§
1. **è‡ªå®šä¹‰APIé…ç½®ç•Œé¢**: 
   - APIåç§°è®¾ç½®
   - åŸºç¡€URLé…ç½®
   - APIå¯†é’¥ç®¡ç†ï¼ˆæ”¯æŒæ˜¾ç¤º/éšè—ï¼‰
   - æä¾›å•†ç±»å‹é€‰æ‹©ï¼ˆOpenAIå…¼å®¹/è‡ªå®šä¹‰æ ¼å¼ï¼‰

2. **è¿æ¥æµ‹è¯•åŠŸèƒ½**: 
   - å®æ—¶APIè¿æ¥æµ‹è¯•
   - æ¨¡å‹åˆ—è¡¨è‡ªåŠ¨è·å–
   - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º

3. **æ¨¡å‹é…ç½®ç®¡ç†**: 
   - å¯ç¼–è¾‘çš„æ¨¡å‹åç§°è¾“å…¥
   - æ¸©åº¦å’Œæœ€å¤§ä»¤ç‰Œæ•°è®¾ç½®
   - æ¨¡å‹åˆ—è¡¨åˆ·æ–°åŠŸèƒ½

4. **AIåŠ©æ‰‹é›†æˆ**: 
   - æ”¯æŒåœ¨AIåŠ©æ‰‹ä¸­åˆ‡æ¢è‡ªå®šä¹‰API
   - å®æ—¶é…ç½®åŒæ­¥
   - å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ˜¾ç¤º

### æŠ€æœ¯å®ç°äº®ç‚¹
1. **é€‚é…å™¨æ¨¡å¼**: é‡‡ç”¨æ ‡å‡†çš„é€‚é…å™¨æ¨¡å¼ï¼Œç¡®ä¿ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§
2. **å¼‚æ­¥æµ‹è¯•**: ä½¿ç”¨QThreadå®ç°å¼‚æ­¥APIæµ‹è¯•ï¼Œé¿å…ç•Œé¢é˜»å¡
3. **é…ç½®æŒä¹…åŒ–**: å®Œæ•´çš„é…ç½®ä¿å­˜å’ŒåŠ è½½æœºåˆ¶ï¼Œæ”¯æŒç”¨æˆ·è®¾ç½®çš„æŒä¹…åŒ–
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæä¾›å‹å¥½çš„é”™è¯¯æç¤º
5. **å‘åå…¼å®¹**: ä¿æŒä¸ç°æœ‰åŠŸèƒ½çš„å®Œå…¨å…¼å®¹ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·çš„ä½¿ç”¨

### ä½¿ç”¨è¯´æ˜
1. åœ¨AIè®¾ç½®ä¸­åˆ‡æ¢åˆ°"è‡ªå®šä¹‰API"æ ‡ç­¾é¡µ
2. å¡«å†™APIåç§°ã€åŸºç¡€URLå’ŒAPIå¯†é’¥
3. é€‰æ‹©APIç±»å‹ï¼ˆæ¨èä½¿ç”¨"OpenAIå…¼å®¹"ï¼‰
4. ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯é…ç½®
5. é…ç½®æ¨¡å‹å‚æ•°ï¼ˆæ¸©åº¦ã€æœ€å¤§ä»¤ç‰Œæ•°ç­‰ï¼‰
6. åœ¨AIåŠ©æ‰‹ä¸­é€‰æ‹©"è‡ªå®šä¹‰API"å³å¯ä½¿ç”¨

è¯¥åŠŸèƒ½å·²å®Œå…¨é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®å³å¯ä½¿ç”¨è‡ªå®šä¹‰çš„LLM APIæœåŠ¡ã€‚ 