# 批量预测准确率计算功能开发完成

## 完成时间
2025年1月6日 10:20

## 功能概述
根据用户需求，在批量预测页面新增了一个智能的准确率计算组件，能够自动分析源文件夹中图片的真实类别（从文件名前缀提取）和输出文件夹中的预测类别（从子文件夹位置获取），计算批量预测的实际准确率。

## 核心功能

### 1. 智能类别提取
**源文件夹类别提取（真实类别）：**
- 支持多种文件名格式：
  - `A123.jpg` → A
  - `A(1).jpg` → A  
  - `A_001.jpg` → A
  - `A-001.jpg` → A
  - `A.001.jpg` → A
  - `Apple123.jpg` → APPLE
  - 等等...

**输出文件夹类别提取（预测类别）：**
- 从文件夹路径提取：`output/A/image.jpg` → A
- 支持多级目录结构

### 2. 准确率计算
- **总体准确率**：正确预测数 / 有效图片数 × 100%
- **各类别准确率**：每个类别的正确预测率
- **混淆矩阵**：详细的预测结果分析
- **验证报告**：类别提取有效性分析

### 3. 多维度结果展示
通过4个标签页展示不同维度的分析结果：

#### 总体统计
- 总图片数、正确预测数、总体准确率
- 各类别准确率概览
- 颜色编码：绿色(≥80%)、橙色(60-80%)、红色(<60%)

#### 类别详情
- 表格形式展示每个类别的详细统计
- 包含：类别名称、总数、正确数、准确率
- 背景颜色标识准确率等级

#### 混淆矩阵
- 行表示真实类别，列表示预测类别
- 对角线元素表示正确预测
- 直观显示各类别间的混淆情况

#### 验证报告
- 类别提取有效性分析
- 源文件夹与输出文件夹类别对比
- 提取失败的文件列表
- 文件名格式建议

## 技术实现

### 1. 组件架构
**文件位置：** `src/ui/components/prediction/accuracy_calculator_widget.py`

**核心类：**
- `AccuracyCalculationThread`：独立线程执行计算
- `AccuracyCalculatorWidget`：UI界面组件

### 2. 关键算法

#### 类别提取算法
```python
def _extract_class_from_filename(self, filename):
    """从文件名中提取类别信息"""
    patterns = [
        r'^([A-Za-z]+)\d+.*',          # A123.jpg -> A
        r'^([A-Za-z]+)\(\d+\).*',      # A(1).jpg -> A
        r'^([A-Za-z]+)_.*',            # A_001.jpg -> A
        r'^([A-Za-z]+)-.*',            # A-001.jpg -> A
        r'^([A-Za-z]+)\..*',           # A.001.jpg -> A
        r'^([A-Za-z]+)[\d_\-\(\)\.].*', # 通用模式
        r'^([A-Za-z]+)',               # 纯字母
    ]
    # 按优先级匹配，返回大写类别名
```

#### 准确率计算算法
```python
def _calculate_accuracy(self, source_images, output_images):
    """计算准确率"""
    # 1. 验证类别提取有效性
    # 2. 统计各类别的预测结果
    # 3. 构建混淆矩阵
    # 4. 计算总体和各类别准确率
    # 5. 生成验证报告
```

### 3. 数据结构

#### 结果数据结构
```python
results = {
    'total_images': 总图片数,
    'valid_images': 有效图片数,
    'matched_images': 正确预测数,
    'overall_accuracy': 总体准确率,
    'class_stats': 各类别统计,
    'class_accuracies': 各类别准确率,
    'confusion_matrix': 混淆矩阵,
    'unprocessed_images': 未处理图片数,
    'validation_report': 验证报告
}
```

## 用户界面集成

### 1. 集成位置
- 在批量预测页面底部添加"预测准确率分析"组件
- 批量预测完成后自动设置文件夹路径

### 2. 操作流程
1. 执行批量预测
2. 预测完成后，准确率组件自动获取源文件夹和输出文件夹路径
3. 点击"开始计算准确率"按钮
4. 查看多维度分析结果
5. 可导出结果为JSON格式

### 3. 用户友好特性
- 自动路径设置：批量预测完成后自动填充路径
- 进度显示：计算过程中显示进度条和状态信息
- 错误处理：友好的错误提示和处理
- 结果导出：支持导出详细结果为JSON文件

## 验证与测试

### 1. 测试脚本
**文件位置：** `test script/test_accuracy_calculator.py`

**测试场景：**
- 创建模拟的源文件夹和输出文件夹
- 模拟不同的预测结果（正确/错误）
- 验证准确率计算的正确性

### 2. 测试结果
- 总体准确率计算：✅ 正确
- 各类别准确率计算：✅ 正确
- 混淆矩阵生成：✅ 正确
- 类别提取算法：✅ 支持多种格式

## 使用说明

### 1. 基本使用
1. 在批量预测页面执行批量预测
2. 预测完成后，滚动到页面底部的"预测准确率分析"区域
3. 确认源文件夹和输出文件夹路径正确
4. 点击"开始计算准确率"按钮
5. 等待计算完成，查看结果

### 2. 文件名要求
**推荐的文件名格式：**
- `A(1).jpg, A(2).jpg, ...` - 最常用
- `A123.jpg, A456.jpg, ...` - 数字编号
- `A_001.jpg, A_002.jpg, ...` - 下划线分隔
- `A-001.jpg, A-002.jpg, ...` - 连字符分隔

**注意事项：**
- 文件名前缀必须是字母（代表类别）
- 类别名称不区分大小写（内部统一转为大写）
- 不支持纯数字或特殊字符开头的文件名

### 3. 结果解读
- **总体准确率**：所有类别的平均准确率
- **绿色(≥80%)**：准确率良好
- **橙色(60-80%)**：准确率一般，需要改进
- **红色(<60%)**：准确率较低，需要重点关注

## 技术优势

### 1. 智能化
- 自动识别多种文件名格式
- 智能验证类别提取有效性
- 自动生成详细的分析报告

### 2. 用户友好
- 直观的多标签页界面
- 颜色编码的可视化效果
- 详细的验证报告和建议

### 3. 高性能
- 独立线程执行，不阻塞UI
- 进度显示和状态反馈
- 支持大量图片的批量分析

### 4. 扩展性
- 易于添加新的文件名格式支持
- 可扩展更多统计指标
- 支持导出多种格式

## 未来改进方向

1. **支持更多文件名格式**：根据用户反馈添加新的模式
2. **可视化图表**：添加柱状图、饼图等可视化展示
3. **批量处理优化**：支持更大规模的图片分析
4. **自定义类别映射**：支持用户自定义类别名称映射
5. **详细错误诊断**：提供更详细的错误分析和修复建议

## 总结

批量预测准确率计算功能已成功集成到系统中，为用户提供了全面的预测结果分析能力。该功能不仅能够准确计算预测准确率，还能提供详细的验证报告，帮助用户了解模型的性能表现和改进方向。

通过智能的类别提取算法和多维度的结果展示，用户可以快速了解批量预测的质量，为模型优化和数据改进提供有力支持。 