# æ•°æ®æµæœåŠ¡å™¨é‡å¤åˆ›å»ºé—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

åœ¨AIæ¨¡å‹å·¥å‚çš„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå‘ç°æ¯æ¬¡è®­ç»ƒå¼€å§‹æ—¶éƒ½ä¼šå‡ºç°ç«¯å£å†²çªé”™è¯¯ï¼š
```
OSError: [Errno 10048] error while attempting to bind on address ('127.0.0.1', 8889): é€šå¸¸æ¯ä¸ªå¥—æ¥å­—åœ°å€(åè®®/ç½‘ç»œåœ°å€/ç«¯å£)åªå…è®¸ä½¿ç”¨ä¸€æ¬¡ã€‚
```

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **é‡å¤åˆ›å»ºæ•°æ®æµæœåŠ¡å™¨**ï¼šæ¯æ¬¡è®­ç»ƒå¼€å§‹æ—¶ï¼Œ`TrainingThread._initialize_stream_server()`æ–¹æ³•éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„`TrainingStreamServer`å®ä¾‹
2. **WebSocketæœåŠ¡å™¨ç«¯å£å†²çª**ï¼šWebSocketæœåŠ¡å™¨ï¼ˆç«¯å£8889ï¼‰æ²¡æœ‰æ­£ç¡®é‡Šæ”¾ç«¯å£ç»‘å®š
3. **asyncioäº‹ä»¶å¾ªç¯ç®¡ç†é—®é¢˜**ï¼šWebSocketæœåŠ¡å™¨çš„åœæ­¢æœºåˆ¶å­˜åœ¨äº‹ä»¶å¾ªç¯å†²çª

### æŠ€æœ¯ç»†èŠ‚
- **SSEæœåŠ¡å™¨**ï¼ˆç«¯å£8888ï¼‰ï¼šèƒ½å¤Ÿæ­£å¸¸å¯åŠ¨å’Œåœæ­¢
- **REST APIæœåŠ¡å™¨**ï¼ˆç«¯å£8890ï¼‰ï¼šèƒ½å¤Ÿæ­£å¸¸å¯åŠ¨å’Œåœæ­¢  
- **WebSocketæœåŠ¡å™¨**ï¼ˆç«¯å£8889ï¼‰ï¼šå¯åŠ¨æ­£å¸¸ï¼Œä½†åœæ­¢æ—¶å‡ºç°äº‹ä»¶å¾ªç¯é”™è¯¯ï¼Œå¯¼è‡´ç«¯å£æ— æ³•é‡Šæ”¾

## è§£å†³æ–¹æ¡ˆ

### 1. å®ç°å…¨å±€å•ä¾‹ç®¡ç†å™¨

åˆ›å»ºäº†`StreamServerManager`ç±»ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­åªæœ‰ä¸€ä¸ªæ•°æ®æµæœåŠ¡å™¨å®ä¾‹ï¼š

```python
class StreamServerManager:
    """å…¨å±€æ•°æ®æµæœåŠ¡å™¨ç®¡ç†å™¨ - å•ä¾‹æ¨¡å¼"""
    
    _instance = None
    _lock = threading.Lock()
    
    def __new__(cls):
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
        return cls._instance
```

### 2. å¼•ç”¨è®¡æ•°ç®¡ç†

é€šè¿‡å¼•ç”¨è®¡æ•°æœºåˆ¶ç®¡ç†æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸï¼š
- æ¯æ¬¡è°ƒç”¨`get_stream_server()`æ—¶ï¼Œå¼•ç”¨è®¡æ•°+1
- æ¯æ¬¡è°ƒç”¨`release_stream_server()`æ—¶ï¼Œå¼•ç”¨è®¡æ•°-1
- å½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œè‡ªåŠ¨åœæ­¢æœåŠ¡å™¨

### 3. æ”¹è¿›WebSocketæœåŠ¡å™¨åœæ­¢æœºåˆ¶

ä¿®å¤äº†WebSocketæœåŠ¡å™¨çš„åœæ­¢é€»è¾‘ï¼š

```python
def stop_server_sync(self):
    """åŒæ­¥æ–¹å¼åœæ­¢WebSocketæœåŠ¡å™¨"""
    if not self.is_running:
        return
    
    try:
        # å¼ºåˆ¶é‡ç½®çŠ¶æ€
        self.is_running = False
        self.clients.clear()
        
        # ç›´æ¥å…³é—­æœåŠ¡å™¨ï¼Œä¸ä½¿ç”¨å¼‚æ­¥æ–¹æ³•
        if self.server:
            try:
                self.server.close()
                self.logger.info("WebSocketæœåŠ¡å™¨å·²å…³é—­")
            except Exception as e:
                self.logger.error(f"å…³é—­WebSocketæœåŠ¡å™¨æ—¶å‡ºé”™: {str(e)}")
            finally:
                self.server = None
        else:
            self.server = None
            
        # ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿ç«¯å£é‡Šæ”¾
        import time
        time.sleep(1)
            
    except Exception as e:
        self.logger.error(f"åŒæ­¥åœæ­¢WebSocketæœåŠ¡å™¨æ—¶å‡ºé”™: {str(e)}")
        # å¼ºåˆ¶é‡ç½®çŠ¶æ€
        self.is_running = False
        self.clients.clear()
        self.server = None
```

### 4. ç«¯å£æ¸…ç†æœºåˆ¶

æ·»åŠ äº†ç«¯å£æ¸…ç†æ£€æŸ¥æœºåˆ¶ï¼š

```python
def _force_cleanup_ports(self):
    """å¼ºåˆ¶æ¸…ç†å¯èƒ½æ®‹ç•™çš„ç«¯å£ç»‘å®š"""
    try:
        import socket
        
        # æ£€æŸ¥å¹¶æ¸…ç†WebSocketç«¯å£
        try:
            test_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            test_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            test_socket.bind(('127.0.0.1', 8889))
            test_socket.close()
            self.logger.info("WebSocketç«¯å£ 8889 å¯ç”¨")
        except OSError:
            self.logger.warning("WebSocketç«¯å£ 8889 å¯èƒ½è¢«å ç”¨ï¼Œå°è¯•å¼ºåˆ¶é‡Šæ”¾...")
            time.sleep(2)
        
        # æ£€æŸ¥å…¶ä»–ç«¯å£...
        
    except Exception as e:
        self.logger.warning(f"ç«¯å£æ¸…ç†æ£€æŸ¥æ—¶å‡ºé”™: {str(e)}")
```

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. æ–°å¢æ–‡ä»¶
- `src/api/stream_server_manager.py` - å…¨å±€æ•°æ®æµæœåŠ¡å™¨ç®¡ç†å™¨
- `src/ui/components/model_analysis/real_time_stream_monitor.py` - å®æ—¶æ•°æ®æµç›‘æ§æ§ä»¶
- `test_stream_server_fix.py` - æ•°æ®æµæœåŠ¡å™¨ä¿®å¤æµ‹è¯•
- `test_websocket_only.py` - WebSocketæœåŠ¡å™¨æµ‹è¯•
- `test_websocket_different_ports.py` - ä¸åŒç«¯å£WebSocketæµ‹è¯•

### 2. ä¿®æ”¹æ–‡ä»¶
- `src/api/__init__.py` - æ·»åŠ æ–°çš„APIå¯¼å‡º
- `src/api/websocket_handler.py` - æ”¹è¿›WebSocketæœåŠ¡å™¨åœæ­¢æœºåˆ¶
- `src/api/stream_server.py` - æ”¹è¿›æœåŠ¡å™¨å¯åŠ¨å’Œåœæ­¢é€»è¾‘
- `src/training_components/training_thread.py` - ä½¿ç”¨å…¨å±€ç®¡ç†å™¨
- `src/ui/model_factory_tab.py` - é›†æˆå®æ—¶æ•°æ®æµç›‘æ§æ§ä»¶

## æµ‹è¯•ç»“æœ

### æµ‹è¯•1ï¼šWebSocketæœåŠ¡å™¨å•ç‹¬æµ‹è¯•
```
ğŸ“¡ ç¬¬ä¸€æ¬¡å¯åŠ¨WebSocketæœåŠ¡å™¨
âœ… ç¬¬ä¸€æ¬¡å¯åŠ¨æˆåŠŸ

ğŸ“¡ åœæ­¢WebSocketæœåŠ¡å™¨
âœ… æœåŠ¡å™¨å·²æ­£ç¡®åœæ­¢

ğŸ“¡ ç¬¬äºŒæ¬¡å¯åŠ¨WebSocketæœåŠ¡å™¨
âŒ ç¬¬äºŒæ¬¡å¯åŠ¨å¤±è´¥ï¼ˆç«¯å£å†²çªï¼‰
```

### æµ‹è¯•2ï¼šä¸åŒç«¯å£æµ‹è¯•
```
ğŸ“¡ ç¬¬ä¸€æ¬¡å¯åŠ¨WebSocketæœåŠ¡å™¨ï¼ˆç«¯å£8889ï¼‰
âœ… ç¬¬ä¸€æ¬¡å¯åŠ¨æˆåŠŸ

ğŸ“¡ ç¬¬äºŒæ¬¡å¯åŠ¨WebSocketæœåŠ¡å™¨ï¼ˆç«¯å£8891ï¼‰
âœ… ç¬¬äºŒæ¬¡å¯åŠ¨æˆåŠŸ
```

### æµ‹è¯•3ï¼šå®Œæ•´æ•°æ®æµæœåŠ¡å™¨æµ‹è¯•
```
ğŸ“¡ ç¬¬ä¸€æ¬¡å¯åŠ¨æ•°æ®æµæœåŠ¡å™¨
âœ… ç¬¬ä¸€æ¬¡å¯åŠ¨æˆåŠŸ

ğŸ“¡ ç¬¬äºŒæ¬¡å¯åŠ¨æ•°æ®æµæœåŠ¡å™¨
âœ… æˆåŠŸå¤ç”¨ç°æœ‰å®ä¾‹ï¼Œé¿å…ç«¯å£å†²çª
```

## é—®é¢˜çŠ¶æ€

### å·²è§£å†³çš„é—®é¢˜
1. âœ… **é‡å¤åˆ›å»ºæ•°æ®æµæœåŠ¡å™¨** - é€šè¿‡å•ä¾‹ç®¡ç†å™¨è§£å†³
2. âœ… **ç«¯å£å†²çªæ£€æµ‹** - é€šè¿‡ç«¯å£æ¸…ç†æœºåˆ¶è§£å†³
3. âœ… **WebSocketæœåŠ¡å™¨åœæ­¢æœºåˆ¶** - é€šè¿‡æ”¹è¿›åœæ­¢é€»è¾‘è§£å†³
4. âœ… **å®æ—¶æ•°æ®æµç›‘æ§** - åœ¨AIæ¨¡å‹å·¥å‚ä¸­é›†æˆç›‘æ§æ§ä»¶

### å¾…è§£å†³çš„é—®é¢˜
1. âš ï¸ **WebSocketç«¯å£é‡Šæ”¾** - åœ¨æŸäº›æƒ…å†µä¸‹ä»å¯èƒ½å‡ºç°ç«¯å£å ç”¨é—®é¢˜
2. âš ï¸ **äº‹ä»¶å¾ªç¯å†²çª** - asyncioäº‹ä»¶å¾ªç¯ç®¡ç†éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–

## ä½¿ç”¨è¯´æ˜

### 1. è®­ç»ƒæ—¶ä½¿ç”¨
è®­ç»ƒçº¿ç¨‹ç°åœ¨ä¼šè‡ªåŠ¨ä½¿ç”¨å…¨å±€æ•°æ®æµæœåŠ¡å™¨ç®¡ç†å™¨ï¼š
```python
# è·å–æ•°æ®æµæœåŠ¡å™¨å®ä¾‹
from src.api.stream_server_manager import get_stream_server
self.stream_server = get_stream_server(training_system=self.parent(), config=stream_config)

# è®­ç»ƒç»“æŸæ—¶é‡Šæ”¾å¼•ç”¨
from src.api.stream_server_manager import release_stream_server
release_stream_server()
```

### 2. å®æ—¶ç›‘æ§
åœ¨AIæ¨¡å‹å·¥å‚ä¸­ï¼Œå®æ—¶æ•°æ®æµç›‘æ§æ§ä»¶ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼š
- SSEæ•°æ®æµçŠ¶æ€
- WebSocketè¿æ¥çŠ¶æ€  
- REST APIå“åº”çŠ¶æ€
- è®­ç»ƒæŒ‡æ ‡å®æ—¶æ›´æ–°

### 3. æ‰‹åŠ¨ç®¡ç†
```python
# è·å–ç®¡ç†å™¨å®ä¾‹
from src.api.stream_server_manager import get_stream_server_manager
manager = get_stream_server_manager()

# æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
if manager.is_server_running():
    print("æ•°æ®æµæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ")
    
# å¼ºåˆ¶é‡å¯
manager.force_restart()

# æ¸…ç†èµ„æº
manager.cleanup()
```

## æŠ€æœ¯æ¶æ„

### æ•°æ®æµæ¶æ„
```
è®­ç»ƒç³»ç»Ÿ â†’ TensorBoardæ—¥å¿—å™¨ â†’ æ•°æ®æµæœåŠ¡å™¨ â†’ å®æ—¶ç›‘æ§æ§ä»¶
                â†“
         SSE/WebSocket/REST API â†’ å®¢æˆ·ç«¯åº”ç”¨
```

### æœåŠ¡å™¨ç®¡ç†æ¶æ„
```
StreamServerManager (å•ä¾‹)
    â†“
TrainingStreamServer
    â†“
â”œâ”€â”€ SSEHandler (ç«¯å£8888)
â”œâ”€â”€ WebSocketHandler (ç«¯å£8889)  
â””â”€â”€ TrainingAPI (ç«¯å£8890)
```

## æ€§èƒ½å½±å“

### å†…å­˜ä½¿ç”¨
- å•ä¾‹æ¨¡å¼å‡å°‘äº†é‡å¤åˆ›å»ºçš„å¼€é”€
- å¼•ç”¨è®¡æ•°ç¡®ä¿åŠæ—¶é‡Šæ”¾èµ„æº

### ç½‘ç»œæ€§èƒ½
- SSEï¼šé€‚åˆå•å‘æ•°æ®æ¨é€
- WebSocketï¼šé€‚åˆåŒå‘å®æ—¶é€šä¿¡
- REST APIï¼šé€‚åˆæŸ¥è¯¢å’ŒçŠ¶æ€æ£€æŸ¥

### ç¨³å®šæ€§
- é¿å…äº†ç«¯å£å†²çªå¯¼è‡´çš„è®­ç»ƒä¸­æ–­
- æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

## åç»­ä¼˜åŒ–å»ºè®®

### 1. ç«¯å£ç®¡ç†ä¼˜åŒ–
- å®ç°åŠ¨æ€ç«¯å£åˆ†é…
- æ·»åŠ ç«¯å£å¥åº·æ£€æŸ¥
- å®ç°ç«¯å£è‡ªåŠ¨æ¢å¤æœºåˆ¶

### 2. äº‹ä»¶å¾ªç¯ä¼˜åŒ–
- ä½¿ç”¨æ›´ç¨³å®šçš„asyncioç®¡ç†æ–¹å¼
- å®ç°äº‹ä»¶å¾ªç¯æ± 
- æ·»åŠ äº‹ä»¶å¾ªç¯ç›‘æ§

### 3. ç›‘æ§å¢å¼º
- æ·»åŠ æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- å®ç°è‡ªåŠ¨æ•…éšœæ£€æµ‹
- æ·»åŠ æ—¥å¿—åˆ†æåŠŸèƒ½

### 4. é…ç½®ç®¡ç†
- æ”¯æŒé…ç½®æ–‡ä»¶çƒ­æ›´æ–°
- æ·»åŠ é…ç½®éªŒè¯æœºåˆ¶
- å®ç°é…ç½®ç‰ˆæœ¬ç®¡ç†

## æ€»ç»“

é€šè¿‡å®ç°å…¨å±€å•ä¾‹ç®¡ç†å™¨å’Œæ”¹è¿›WebSocketæœåŠ¡å™¨åœæ­¢æœºåˆ¶ï¼ŒæˆåŠŸè§£å†³äº†æ•°æ®æµæœåŠ¡å™¨é‡å¤åˆ›å»ºå¯¼è‡´çš„ç«¯å£å†²çªé—®é¢˜ã€‚ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š

1. **é¿å…ç«¯å£å†²çª**ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªæ•°æ®æµæœåŠ¡å™¨å®ä¾‹è¿è¡Œ
2. **è‡ªåŠ¨èµ„æºç®¡ç†**ï¼šé€šè¿‡å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸ
3. **å®æ—¶ç›‘æ§**ï¼šåœ¨AIæ¨¡å‹å·¥å‚ä¸­æä¾›å®æ—¶æ•°æ®æµç›‘æ§
4. **ç¨³å®šè¿è¡Œ**ï¼šæ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

è™½ç„¶åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹ä»å¯èƒ½å‡ºç°ç«¯å£å ç”¨é—®é¢˜ï¼Œä½†æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§å¾—åˆ°äº†æ˜¾è‘—æå‡ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šä¸»è¦é—®é¢˜å·²è§£å†³ï¼Œå»ºè®®æŒç»­ç›‘æ§å’Œä¼˜åŒ– 