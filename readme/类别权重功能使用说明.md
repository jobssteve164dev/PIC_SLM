# 类别权重功能使用说明

## 概述

本文档详细介绍了图片分类模型训练系统中的类别权重功能。经过改进后，训练算法现在能够自动识别和使用多种格式的类别权重配置，有效解决数据集中的类别不平衡问题。

## 功能特点

### 🎯 核心改进

1. **多源权重读取**: 支持从多种配置源读取权重信息
2. **智能配置验证**: 自动验证权重配置与数据集类别的匹配性
3. **详细诊断信息**: 提供完整的权重加载和验证日志
4. **向下兼容**: 完全兼容旧版本的配置格式

### 📋 支持的权重配置格式

#### 1. 设置界面配置格式 (class_weights)
```json
{
    "class_weights": {
        "Missing_hole": 1.5,
        "Mouse_bite": 2.0,
        "Open_circuit": 1.2,
        "Short": 1.8,
        "Spur": 1.0,
        "Spurious_copper": 2.5
    },
    "weight_strategy": "custom",
    "use_class_weights": true
}
```

#### 2. 数据集评估导出格式 (weight_config)
```json
{
    "dataset_info": {
        "dataset_path": "路径",
        "total_classes": 6,
        "analysis_date": "2025-06-04"
    },
    "weight_config": {
        "classes": ["Missing_hole", "Mouse_bite", ...],
        "class_weights": {
            "Missing_hole": 1.5,
            "Mouse_bite": 2.0,
            ...
        },
        "weight_strategy": "balanced"
    }
}
```

#### 3. 外部权重配置文件
```json
{
    "weight_config_file": "path/to/weights.json"
}
```

#### 4. 多策略权重格式 (all_strategies)
```json
{
    "all_strategies": {
        "balanced": {"class1": 1.0, "class2": 1.2, ...},
        "custom": {"class1": 2.0, "class2": 1.5, ...},
        "inverse": {"class1": 3.0, "class2": 0.8, ...}
    },
    "weight_strategy": "custom"
}
```

#### 5. 旧版格式 (custom_class_weights)
```json
{
    "custom_class_weights": {
        "Missing_hole": 1.2,
        "Mouse_bite": 2.5,
        ...
    }
}
```

## 使用步骤

### 方法一：通过设置界面配置

1. **打开设置页面**
   - 在主界面中选择"设置"标签页

2. **配置类别权重**
   - 在"缺陷类别与权重配置"部分添加类别
   - 为每个类别设置权重值（建议范围：0.1 - 10.0）
   - 选择权重策略为"custom (自定义权重)"

3. **保存配置**
   - 点击"保存设置"按钮
   - 配置会自动保存到系统配置文件

4. **开始训练**
   - 确保在训练配置中启用"使用类别权重"
   - 启动训练过程

### 方法二：使用数据集评估导出的权重

1. **分析数据集**
   - 在"数据集评估"页面分析训练数据集
   - 系统会自动计算各种权重策略

2. **导出权重配置**
   - 选择合适的权重策略（如balanced、inverse等）
   - 点击"导出权重配置"按钮
   - 保存权重配置文件（如`class_weights_balanced.json`）

3. **在设置中加载权重**
   - 在设置页面点击"加载类别配置"
   - 选择导出的权重配置文件
   - 系统会自动识别文件格式并加载权重

4. **训练验证**
   - 启动训练，系统会自动验证权重配置

### 方法三：直接编辑配置文件

1. **找到配置文件**
   - 主配置文件：`config.json`
   - 或创建独立的权重配置文件

2. **添加权重配置**
   ```json
   {
       "class_weights": {
           "类别1": 权重值,
           "类别2": 权重值,
           ...
       },
       "weight_strategy": "custom",
       "use_class_weights": true
   }
   ```

3. **启动训练**
   - 系统会自动读取并验证配置

## 权重策略说明

### 🎛️ 可用策略

| 策略 | 描述 | 适用场景 |
|------|------|----------|
| `balanced` | sklearn平衡权重 | 中等不平衡，推荐首选 |
| `inverse` | 逆频率权重 | 严重不平衡，权重差异大 |
| `log_inverse` | 对数逆频率权重 | 严重不平衡，减少权重差异 |
| `custom` | 自定义权重 | 特定需求，手动调优 |
| `none` | 无权重 | 平衡数据集 |

### 📊 权重计算公式

- **balanced**: `n_samples / (n_classes * np.bincount(y))`
- **inverse**: `total_samples / (n_classes * class_count)`
- **log_inverse**: `log(total_samples / class_count)`
- **custom**: 用户指定的权重值

## 训练过程中的诊断信息

### 🔍 权重配置验证

训练开始时，系统会自动验证权重配置：

```
验证权重配置...
检查权重源: 配置中的class_weights
  数据集类别数: 6
  配置中类别数: 6
  匹配类别数: 6
  权重范围: 1.000 - 2.500
  权重均值: 1.667
  ✓ 推荐权重源: 配置中的class_weights (完全匹配)
```

### 📈 类别分布统计

```
类别分布统计:
  Missing_hole: 88 个样本
  Mouse_bite: 88 个样本
  Open_circuit: 88 个样本
  Short: 88 个样本
  Spur: 88 个样本
  Spurious_copper: 88 个样本
```

### ⚖️ 权重应用信息

```
使用权重策略: custom
  Missing_hole: 权重 = 1.5000
  Mouse_bite: 权重 = 2.0000
  Open_circuit: 权重 = 1.2000
  Short: 权重 = 1.8000
  Spur: 权重 = 1.0000
  Spurious_copper: 权重 = 2.5000
使用加权损失函数，权重策略: custom
```

## 常见问题解决

### ❓ 问题：权重配置未生效

**可能原因和解决方案：**

1. **权重策略设置错误**
   - 确保 `weight_strategy` 设置为 `"custom"`
   - 确保 `use_class_weights` 设置为 `true`

2. **类别名称不匹配**
   - 检查配置中的类别名称是否与数据集文件夹名称完全一致
   - 注意大小写和特殊字符

3. **配置格式错误**
   - 验证JSON格式是否正确
   - 确保权重值为数字类型

### ❓ 问题：所有权重都是1.0

**诊断步骤：**

1. 检查训练日志中的权重验证信息
2. 确认权重配置源是否被正确识别
3. 验证权重策略是否设置为`custom`

### ❓ 问题：部分类别权重缺失

**解决方案：**

1. 系统会为缺失的类别自动分配默认权重1.0
2. 建议补全所有类别的权重配置
3. 使用数据集评估功能重新生成完整权重配置

## 最佳实践

### 🎯 权重设置建议

1. **轻度不平衡** (比例 1:2-1:3)
   - 使用 `balanced` 策略
   - 或设置较小的权重差异 (1.0 - 2.0)

2. **中度不平衡** (比例 1:5-1:10)
   - 使用 `inverse` 或 `log_inverse` 策略
   - 或设置中等权重差异 (1.0 - 5.0)

3. **严重不平衡** (比例 1:10+)
   - 使用 `log_inverse` 策略避免过度加权
   - 或谨慎设置自定义权重 (1.0 - 10.0)

### 📋 配置管理建议

1. **使用版本控制**
   - 为权重配置文件添加版本信息
   - 记录权重调整的原因和效果

2. **实验跟踪**
   - 使用TensorBoard监控不同权重配置的效果
   - 记录验证集上的指标变化

3. **配置备份**
   - 定期备份有效的权重配置
   - 建立配置文件命名规范

## 测试验证

### 🧪 功能测试

可以使用项目中的测试脚本验证权重加载功能：

```bash
python test_weight_loading.py
```

该脚本会测试各种权重配置格式的加载情况。

### 📊 效果评估

1. **训练监控**
   - 观察TensorBoard中的类别权重分布图
   - 监控各类别的损失和准确率

2. **验证指标**
   - 检查混淆矩阵中各类别的表现
   - 计算F1-score、精确率、召回率等指标

## 总结

经过改进的类别权重功能现在提供了：

- ✅ **多格式支持**: 自动识别各种权重配置格式
- ✅ **智能验证**: 自动检查配置与数据集的匹配性
- ✅ **详细诊断**: 提供完整的加载和验证信息
- ✅ **易于使用**: 支持界面配置和文件导入
- ✅ **向下兼容**: 兼容所有旧版本配置格式

这些改进确保了训练算法能够正确识别和使用类别权重信息，有效解决数据集不平衡问题，提升模型训练效果。 