# 类别权重功能使用指南

## 功能概述

本系统新增了类别权重功能，用于解决训练数据中不同类别样本数量不平衡的问题。通过为不同类别设置不同的权重，可以让模型更好地学习少数类别的特征，从而提高整体分类性能。

## 功能特点

### 🎯 核心优势
- **自动平衡**: 系统自动计算最优权重，无需手动调整
- **多种策略**: 提供多种权重计算策略，适应不同场景
- **可视化支持**: 在TensorBoard中显示类别分布和权重信息
- **灵活配置**: 支持自定义权重，满足特殊需求

### 📊 权重策略说明

1. **balanced (平衡权重)** - 推荐
   - 使用sklearn的计算方法
   - 自动根据样本数量分布计算权重
   - 权重 = 总样本数 / (类别数 × 该类别样本数)

2. **inverse (逆频率权重)**
   - 权重与样本数量成反比
   - 样本越少的类别权重越大
   - 权重 = 总样本数 / (类别数 × 该类别样本数)

3. **log_inverse (对数逆频率权重)**
   - 使用对数缓解权重差异过大的问题
   - 权重 = log(总样本数 / 该类别样本数)
   - 适合极度不平衡的数据集

4. **custom (自定义权重)**
   - 手动设置每个类别的权重
   - 适合有特定业务需求的场景
   - 可根据经验或专业知识调整

5. **none (无权重)**
   - 不使用权重，所有类别同等对待
   - 适合样本分布相对均衡的数据集

## 使用方法

### 1. 在设置界面配置权重

1. 打开应用程序，切换到"设置"标签页
2. 在"默认缺陷类别与权重配置"区域：
   - 选择权重策略（推荐使用"balanced"）
   - 添加或删除类别
   - 如果选择"custom"策略，可手动调整权重值

3. 点击"保存设置"保存配置

### 2. 在训练配置中使用

训练配置文件中的相关参数：

```json
{
    "use_class_weights": true,
    "weight_strategy": "balanced",
    "custom_class_weights": {
        "Missing_hole": 1.0,
        "Mouse_bite": 2.0,
        "Open_circuit": 1.5,
        "Short": 1.0,
        "Spur": 3.0,
        "Spurious_copper": 2.5
    }
}
```

### 3. 查看训练效果

在TensorBoard中可以查看：
- 类别样本分布图
- 类别权重分布图
- 训练过程中的损失和准确率变化

## 配置文件格式

### 主配置文件 (config.json)
```json
{
    "default_classes": [
        "Missing_hole",
        "Mouse_bite",
        "Open_circuit",
        "Short",
        "Spur",
        "Spurious_copper"
    ],
    "class_weights": {
        "Missing_hole": 1.0,
        "Mouse_bite": 2.0,
        "Open_circuit": 1.5,
        "Short": 1.0,
        "Spur": 3.0,
        "Spurious_copper": 2.5
    },
    "weight_strategy": "balanced",
    "use_class_weights": true,
    "version": "2.0"
}
```

### 类别配置文件示例
```json
{
    "classes": [
        "Missing_hole",
        "Mouse_bite",
        "Open_circuit",
        "Short",
        "Spur",
        "Spurious_copper"
    ],
    "class_weights": {
        "Missing_hole": 1.0,
        "Mouse_bite": 2.0,
        "Open_circuit": 1.5,
        "Short": 1.0,
        "Spur": 3.0,
        "Spurious_copper": 2.5
    },
    "weight_strategy": "custom",
    "use_class_weights": true,
    "description": "缺陷类别配置文件，包含类别名称、权重信息和权重策略",
    "version": "2.0"
}
```

## 最佳实践

### 🎯 权重策略选择建议

1. **数据集初期**: 使用 `balanced` 策略
2. **轻度不平衡**: 使用 `inverse` 策略
3. **严重不平衡**: 使用 `log_inverse` 策略
4. **特殊需求**: 使用 `custom` 策略

### 📈 权重设置指南

- **权重范围**: 建议在 0.1 - 10.0 之间
- **少数类别**: 设置较高权重 (2.0 - 5.0)
- **多数类别**: 设置较低权重 (0.5 - 1.0)
- **重要类别**: 可适当提高权重

### 🔧 调优建议

1. **先尝试自动策略**: 从 `balanced` 开始
2. **观察训练效果**: 查看混淆矩阵和分类报告
3. **微调权重**: 根据具体类别的表现调整
4. **验证效果**: 在验证集上评估改进情况

## 注意事项

⚠️ **重要提醒**:

1. **权重过大风险**: 权重设置过高可能导致过拟合
2. **平衡考虑**: 需要在少数类别召回率和整体准确率之间平衡
3. **数据质量**: 权重无法解决数据质量问题，确保少数类别样本质量
4. **交叉验证**: 建议使用交叉验证评估不同权重策略的效果

## 问题排查

### Q: 设置权重后训练效果没有改善？
A: 
- 检查权重策略是否适合当前数据分布
- 尝试不同的权重值
- 确认数据集是否存在标注错误
- 考虑增加数据增强

### Q: 自定义权重如何设置？
A:
- 分析各类别的样本数量
- 计算样本比例的倒数作为初始权重
- 根据业务重要性调整
- 通过实验验证效果

### Q: TensorBoard中看不到权重信息？
A:
- 确认已启用TensorBoard日志记录
- 检查权重策略是否正确设置
- 重新训练一轮以更新日志

## 版本更新说明

### v2.0 新特性
- ✅ 新增类别权重功能
- ✅ 支持多种权重计算策略
- ✅ TensorBoard可视化支持
- ✅ 配置文件格式升级
- ✅ 界面交互优化

### 兼容性
- 🔄 自动兼容 v1.0 配置文件
- 🔄 向后兼容原有训练配置
- 🔄 无缝升级，无需重新配置

---

> 💡 **提示**: 如有任何问题或建议，请查看系统日志或联系技术支持。 