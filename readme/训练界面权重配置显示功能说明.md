# 训练界面权重配置显示功能说明

## 功能概述

在模型训练界面的数据集目录下新增了一个"类别权重配置"显示组，用于实时显示和监控当前的类别权重配置信息。

## 功能特点

### 🎯 实时权重信息显示

1. **权重策略显示**: 显示当前使用的权重策略（如balanced、custom等）
2. **配置源显示**: 显示权重配置的来源（如配置文件、外部文件等）
3. **详细权重信息**: 显示类别数量、权重范围、各类别的具体权重值

### 📍 显示位置

- **分类任务**: 在"训练数据目录"组下方
- **检测任务**: 在"训练数据目录"组下方

### 🔄 自动刷新机制

权重配置显示会在以下情况下自动刷新：

1. **界面初始化时**: 首次加载界面时自动检测权重配置
2. **任务类型切换时**: 在分类和检测任务间切换时刷新
3. **数据集路径变更时**: 选择新的数据集文件夹时刷新
4. **手动刷新**: 点击"刷新权重配置"按钮

## 界面元素说明

### 权重策略标签
- **颜色指示**:
  - 🟢 绿色: 已配置权重策略
  - 🔴 红色: 未配置或配置有误
- **显示内容**: 当前权重策略名称（如"balanced"、"custom"等）

### 配置源标签
显示权重配置的来源，可能的值包括：
- `配置文件(class_weights)`: 从主配置文件的class_weights字段读取
- `配置文件(custom_class_weights)`: 从主配置文件的custom_class_weights字段读取
- `外部文件(filename.json)`: 从外部权重配置文件读取
- `all_strategies配置`: 从多策略配置中读取
- `无`: 未找到任何权重配置

### 详细信息文本框
显示完整的权重配置信息，包括：
- 权重策略和配置源
- 类别数量统计
- 权重范围和均值
- 各类别的具体权重值（显示前5个）

### 刷新按钮
- **位置**: 配置源标签右侧
- **功能**: 手动重新检测和加载权重配置
- **提示**: "重新检测和加载类别权重配置"

## 支持的权重配置格式

### 1. 直接配置格式 (class_weights)
```json
{
    "class_weights": {
        "Missing_hole": 1.5,
        "Mouse_bite": 2.0,
        "Open_circuit": 1.2,
        ...
    },
    "weight_strategy": "custom",
    "use_class_weights": true
}
```

### 2. 旧版格式 (custom_class_weights)
```json
{
    "custom_class_weights": {
        "Missing_hole": 1.2,
        "Mouse_bite": 2.5,
        ...
    },
    "weight_strategy": "custom"
}
```

### 3. 外部权重文件
```json
{
    "weight_config_file": "path/to/class_weights_balanced.json"
}
```

### 4. 多策略配置 (all_strategies)
```json
{
    "all_strategies": {
        "balanced": {"class1": 1.0, "class2": 1.2},
        "custom": {"class1": 2.0, "class2": 1.5}
    },
    "weight_strategy": "custom"
}
```

## 显示示例

### 有效权重配置显示
```
权重策略: custom (绿色)
配置源: 配置文件(class_weights)

权重配置详情:
权重策略: custom
配置源: 配置文件(class_weights)
类别数量: 6
权重范围: 1.000 - 2.500
权重均值: 1.667

类别权重详情:
  Missing_hole: 1.500
  Mouse_bite: 2.000
  Open_circuit: 1.200
  Short: 1.800
  Spur: 1.000
  ... 还有 1 个类别
```

### 无权重配置显示
```
权重策略: 未配置 (红色)
配置源: 无

权重配置详情:
未发现任何权重配置

建议:
- 在设置页面配置类别权重
- 使用数据集评估功能生成权重配置
- 手动编辑配置文件添加权重信息
```

## 操作指南

### 如何配置权重

1. **通过设置界面**:
   - 进入"设置"标签页
   - 在"缺陷类别与权重配置"部分添加类别和权重
   - 点击"保存设置"

2. **通过数据集评估**:
   - 进入"数据集评估"标签页
   - 分析数据集得到权重建议
   - 导出权重配置文件
   - 在设置中加载权重配置文件

3. **手动编辑配置文件**:
   - 编辑项目根目录的`config.json`文件
   - 添加`class_weights`字段
   - 设置`weight_strategy`为`custom`
   - 设置`use_class_weights`为`true`

### 故障排除

1. **显示"未配置"**:
   - 检查config.json文件是否存在权重配置
   - 确认权重策略设置正确
   - 验证权重配置文件路径

2. **权重不生效**:
   - 确保`use_class_weights`设置为`true`
   - 检查类别名称是否与数据集一致
   - 验证权重值格式是否正确

3. **刷新后仍无权重**:
   - 检查配置文件权限
   - 确认文件路径正确
   - 查看控制台错误信息

## 技术实现

### 核心方法
- `refresh_weight_config()`: 主刷新方法
- `_load_weight_config()`: 权重配置加载器
- `_update_classification_weight_display()`: 分类任务显示更新
- `_update_detection_weight_display()`: 检测任务显示更新

### 自动刷新触发点
- 界面初始化 (`__init__`)
- 配置应用 (`apply_config`)
- 任务切换 (`on_task_changed`)
- 数据集选择 (`select_classification_folder`, `select_detection_folder`)

## 注意事项

1. **权重配置优先级**:
   - `class_weights` > `custom_class_weights` > `weight_config_file` > `all_strategies`

2. **性能考虑**:
   - 权重配置检测是轻量级操作
   - 仅在需要时读取配置文件
   - 避免频繁的文件I/O操作

3. **用户体验**:
   - 颜色编码提供直观的状态反馈
   - 详细信息帮助用户理解当前配置
   - 建议信息指导用户正确配置

## 总结

新增的权重配置显示功能为用户提供了：
- ✅ **实时权重状态监控**
- ✅ **多种配置格式支持**
- ✅ **直观的视觉反馈**
- ✅ **详细的配置信息**
- ✅ **自动刷新机制**
- ✅ **故障排除指导**

这个功能大大提升了训练界面的可用性，让用户能够清楚地了解当前的类别权重配置状态，确保训练过程中正确使用权重信息。 